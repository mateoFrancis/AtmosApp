<?php 
require_once('api_OpenWeatherMap.php');
require_once('api_FIRMS.php');

$servername = "localhost";                                                      
$username = "Francis";
$password = "Francis";
$dbname = "Atmos";

$LA_zips = [
    
    '90001' => [33.973, -118.248],   '90002' => [33.949, -118.246],
    '90003' => [33.964, -118.273],   '90004' => [34.077, -118.308],
    '90005' => [34.059, -118.308],   '90006' => [34.048, -118.294],
    '90007' => [34.031, -118.284],   '90008' => [34.007, -118.337],
    '90010' => [34.061, -118.321],   '90011' => [34.008, -118.258],
    '90012' => [34.063, -118.238],   '90013' => [34.045, -118.243],
    '90014' => [34.045, -118.251],   '90015' => [34.038, -118.267],
    '90016' => [34.027, -118.361],   '90017' => [34.052, -118.265],
    '90018' => [34.027, -118.316],   '90019' => [34.047, -118.340],
    '90020' => [34.066, -118.308],   '90021' => [34.032, -118.236],
    '90023' => [34.027, -118.216],   '90024' => [34.063, -118.436],
    '90025' => [34.045, -118.442],   '90026' => [34.082, -118.261],
    '90027' => [34.112, -118.291],   '90028' => [34.101, -118.327],
    '90029' => [34.089, -118.296],   '90031' => [34.080, -118.205],
    '90032' => [34.090, -118.180],   '90033' => [34.049, -118.206],
    '90034' => [34.030, -118.404],   '90035' => [34.052, -118.386],
    '90036' => [34.071, -118.349],   '90037' => [34.004, -118.289],
    '90038' => [34.090, -118.326],   '90039' => [34.113, -118.262],
    '90041' => [34.140, -118.209],   '90042' => [34.114, -118.195],
    '90043' => [33.984, -118.334],   '90044' => [33.951, -118.291],
    '90045' => [33.955, -118.388],   '90046' => [34.106, -118.366],
    '90047' => [33.956, -118.309],   '90048' => [34.073, -118.376],
    '90049' => [34.081, -118.481],   '90056' => [33.993, -118.376],
    '90057' => [34.061, -118.276],   '90059' => [33.923, -118.238],
    '90061' => [33.923, -118.278],   '90062' => [34.003, -118.308],
    '90063' => [34.042, -118.192],   '90064' => [34.035, -118.423],
    '90065' => [34.111, -118.219],   '90066' => [34.000, -118.430],
    '90067' => [34.056, -118.417],   '90068' => [34.121, -118.333],
    '90069' => [34.090, -118.384],   '90071' => [34.052, -118.253],
    '90077' => [34.116, -118.446],   '90210' => [34.090, -118.406],
    '90211' => [34.066, -118.382],   '90212' => [34.060, -118.401],
    '90230' => [33.997, -118.398],   '90232' => [34.022, -118.392],
    '90247' => [33.893, -118.296],   '90248' => [33.861, -118.291],
    '90272' => [34.048, -118.538],   '90291' => [33.991, -118.460],
    '90292' => [33.976, -118.451],   '90293' => [33.959, -118.444],
    '91316' => [34.167, -118.516],   '91331' => [34.258, -118.423],
    '91335' => [34.201, -118.546],   '91342' => [34.314, -118.432],
    '91343' => [34.236, -118.484],   '91344' => [34.287, -118.500],
    '91345' => [34.264, -118.444],   '91352' => [34.231, -118.381],
    '91356' => [34.164, -118.545],   '91364' => [34.149, -118.609],
    '91401' => [34.174, -118.429],   '91402' => [34.223, -118.445],
    '91403' => [34.149, -118.466],   '91405' => [34.199, -118.454],
    '91406' => [34.200, -118.493],   '91411' => [34.180, -118.457],
    '91423' => [34.144, -118.430],   '91436' => [34.140, -118.490],
    '91601' => [34.168, -118.375],   '91602' => [34.151, -118.361],
    '91604' => [34.121, -118.390],   '91605' => [34.211, -118.392],
    '91606' => [34.187, -118.392],   '91607' => [34.165, -118.396]
];

$zip_keys = array_keys($LA_zips);

if ($_SERVER["REQUEST_METHOD"] == "POST") {

    $zip = $_POST['zip'];
    $days = $_POST['days'];

    $location = $LA_zips[$zip];

    fetch_and_store_weather($zip);
    fetchFIRMSData($days);
}

function getConnection() {

    $mysqli = mysqli_connect(
       $GLOBALS[ 'servername'],
       $GLOBALS[ 'username'],
       $GLOBALS[ 'password'],
       $GLOBALS[ 'dbname']
    );

    if (!$mysqli) {
        die("Connection failed: " . mysqli_connect_error());
    }

    return $mysqli;
}

function closeConnection($conn) {

    if(mysqli_close($conn)) {

        return true;
    }
    else {
        die();
    }
}

/*
add_weather_data(
    '90210', 'Los Angeles', 'US', 75.3,
    74.0, 70.0, 80.0, 60,
    1012, 5.5, 180, 20,
    'Clear', 'clear sky', '01d', '2024-05-12 15:00:00'
);
*/

function add_weather_data(
    $zip_code, $city_name, $country_code, $temperature,
    $feels_like, $temp_min, $temp_max, $humidity,
    $pressure, $wind_speed, $wind_deg, $cloud_coverage,
    $weather_main, $weather_description, $icon_code, $timestamp_utc
) {

    $db = getConnection();

    //$hpassword = password_hash($password, PASSWORD_DEFAULT);
    
    $sql = "CALL add_weather_data(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)";

    $stmt = mysqli_prepare($db, $sql);
    
   mysqli_stmt_bind_param(
        $stmt, 
        'ssssddddiiidssss',
        $zip_code, $city_name, $country_code, $temperature, 
        $feels_like, $temp_min, $temp_max, $humidity, 
        $pressure, $wind_speed, $wind_deg, $cloud_coverage, 
        $weather_main, $weather_description, $icon_code, $timestamp_utc
    );

    mysqli_stmt_execute($stmt);

    mysqli_stmt_close($stmt);

    closeConnection($db);
}

?>